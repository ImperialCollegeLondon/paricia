{% extends "table_base.html" %}

{% load i18n %}
{% load rest_framework %}
{% load static %}

{% block title %}PARICIA{% endblock title%}
{% block navbar %}{% include "menu_bar.html" %}{% endblock navbar %}
{% block breadcrumbs %}<ul style="margin-top:70px;"></ul>{% endblock breadcrumbs %}



{% block content %}

          <div class="region"  aria-label="{% trans 'request form' %}">
          {% block request_forms %}

          {% if 'GET' in allowed_methods %}
            <form id="get-form" class="pull-right">
              <fieldset>
                {% if api_settings.URL_FORMAT_OVERRIDE %}
                  <div class="btn-group format-selection">
                    <a class="btn btn-primary js-tooltip" href="{{ request.get_full_path }}" rel="nofollow" title="Make a GET request on the {{ name }} resource">GET</a>

                    <button class="btn btn-primary dropdown-toggle js-tooltip" data-toggle="dropdown" title="Specify a format for the GET request">
                      <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                      {% for format in available_formats %}
                        <li>
                          <a class="js-tooltip format-option" href="{% add_query_param request api_settings.URL_FORMAT_OVERRIDE format %}" rel="nofollow" title="Make a GET request on the {{ name }} resource with the format set to `{{ format }}`">{{ format }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  <a class="btn btn-primary js-tooltip" href="{{ request.get_full_path }}" rel="nofollow" title="Make a GET request on the {{ name }} resource">GET</a>
                {% endif %}
              </fieldset>
            </form>
          {% endif %}



          {% if filter_form %}
            <button style="float: right; margin-right: 10px" data-toggle="modal" data-target="#filtersModal" class="btn btn-default">
              <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
              {% trans "Filters" %}
            </button>
          {% endif %}

          {% endblock request_forms %}
          </div>

            <div class="content-main" role="main"  aria-label="{% trans 'main content' %}">
              <div class="page-header">
                <h1>{{ name }}</h1>
              </div>
              <div style="float:left">
                {% block description %}
                  {{ description }}
                {% endblock %}
              </div>



              {% if paginator %}
                <nav style="float: right">
                  {% get_pagination_html paginator %}
                </nav>
              {% endif %}



              <div class="request-info" style="clear: both" aria-label="{% trans 'request info' %}">
<!--                <pre class="prettyprint"><b>{{ request.method }}</b> {{ request.get_full_path }}</pre>-->
              </div>

              <nav style="float:left">
                <button class="btn btn-success button-form js-tooltip" title="Create {{ name }} resource" data-toggle="modal" data-target="#createModal">CREATE</button>
              </nav>


            <!-- Create Modal -->
            <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-body">
                      <div id="post-object-form">
                        {% with form=post_form %}
                          <form action="{{ request.get_full_path }}" method="POST" enctype="multipart/form-data" class="form-horizontal" novalidate>
                            <fieldset>
                              {% csrf_token %}
                              {{ post_form }}
                              <div class="form-actions">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button class="btn btn-post btn-primary js-tooltip" title="Make a POST request on the {{ name }} resource">POST</button>
                              </div>
                            </fieldset>

                          </form>
                        {% endwith %}
                      </div>
                  </div>
                  <div class="modal-footer">
                  </div>
                </div>
              </div>
            </div>


            <!-- Update Modal -->
            <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-body" id="update_modal_body">

                  </div>
                  <div class="modal-footer">
                  </div>
                </div>
              </div>
            </div>


            <!-- Delete Modal -->
            <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-body">
                    <h4 class="text-center">Are you sure you want to delete this element?</h4>
                    <b></b>
                    <div id="delete_msg"></div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <form class="button-form" action="{{ request.get_full_path }}" data-method="DELETE">
                      <button class="btn btn-danger">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>







              <div class="response-info" aria-label="{% trans 'response info' %}">

              </div>
            <style>
            .table-div {
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
                overflow-y: scroll;
                height: calc(100vh - 220px);
            }
            </style>
              <div class="table-div">

                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">Action</th>
                      {% for key, val in response.data.results.0|items %}
                        <th class="{{ key }}" scope="col">{{ key }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in response.data.results %}
                      <tr>
                        {% for key, val in row|items %}
                          {% if forloop.counter < 2 %}
                          <td style="width:160px;">
                            <button class="btn btn-update btn-warning btn-xs button-form js-tooltip" action="{{ request.path }}{{ val }}/" title="Make an UPDATE request" data-toggle="modal" data-target="#updateModal">UPDATE</button>
                            <button class="btn btn-delete btn-danger btn-xs button-form js-tooltip" action="{{ request.path }}{{ val }}/" title="Make a DELETE request" data-toggle="modal" data-target="#deleteModal">DELETE</button>
                          </td>
                          {% endif %}
                          <td class="{{ key }}">{{ val|default_if_none:"" }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>

              </div>


            </div>

            {% if display_edit_forms %}

              {% if put_form or raw_data_put_form or raw_data_patch_form %}
                <div {% if put_form %}class="tabbable"{% endif %}>
                  {% if put_form %}
                    <ul class="nav nav-tabs form-switcher">
                      <li>
                        <a name='html-tab' href="#put-object-form" data-toggle="tab">HTML form</a>
                      </li>
                      <li>
                        <a  name='raw-tab' href="#put-generic-content-form" data-toggle="tab">Raw data</a>
                      </li>
                    </ul>
                  {% endif %}

                  <div class="well tab-content">
                    {% if put_form %}
                      <div class="tab-pane" id="put-object-form">
                        <form action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data" class="form-horizontal" novalidate>
                          <fieldset>
                            {{ put_form }}
                            <div class="form-actions">
                              <button class="btn btn-primary js-tooltip" title="Make a PUT request on the {{ name }} resource">PUT</button>
                            </div>
                          </fieldset>
                        </form>
                      </div>
                    {% endif %}

                    <div {% if put_form %}class="tab-pane"{% endif %} id="put-generic-content-form">
                      {% with form=raw_data_put_or_patch_form %}
                        <form action="{{ request.get_full_path }}" data-method="PUT" class="form-horizontal">
                          <fieldset>
                            {% include "rest_framework/raw_data_form.html" %}
                            <div class="form-actions">
                              {% if raw_data_put_form %}
                                <button class="btn btn-primary js-tooltip" title="Make a PUT request on the {{ name }} resource">PUT</button>
                              {% endif %}
                              {% if raw_data_patch_form %}
                              <button data-method="PATCH" class="btn btn-primary js-tooltip" title="Make a PATCH request on the {{ name }} resource">PATCH</button>
                                {% endif %}
                            </div>
                          </fieldset>
                        </form>
                      {% endwith %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endif %}

{% endblock content %}

{% block script %}
  <script>
    window.drf = {
      csrfHeaderName: "{{ csrf_header_name|default:'X-CSRFToken' }}",
      csrfToken: "{% if request %}{{ csrf_token }}{% endif %}"
    };
  </script>
  <script src="{% static "rest_framework/js/jquery-3.5.1.min.js" %}"></script>
<!--  <script src="{% static "rest_framework/js/ajax-form.js" %}"></script>-->
  <script src="{% static "rest_framework/js/csrf.js" %}"></script>
  <script src="{% static "rest_framework/js/bootstrap.min.js" %}"></script>
  <script src="{% static "rest_framework/js/prettify-min.js" %}"></script>
  <script src="{% static "rest_framework/js/default.js" %}"></script>
  <script>


function replaceDocument(docString) {
  var doc = document.open("text/html");

  doc.write(docString);
  doc.close();
}

function doAjaxSubmit(e) {

  var form = $(this);
  var btn = $(this.clk);
  var method = (
    btn.data('method') ||
    form.data('method') ||
    form.attr('method') || 'GET'
  ).toUpperCase();

  if (method === 'GET') {
    // GET requests can always use standard form submits.
    return;
  }

  var contentType =
    form.find('input[data-override="content-type"]').val() ||
    form.find('select[data-override="content-type"] option:selected').text();

  if (method === 'POST' && !contentType) {
    // POST requests can use standard form submits, unless we have
    // overridden the content type.
    // return;
  }

  // At this point we need to make an AJAX form submission.
  e.preventDefault();

  var url = form.attr('action');
  var data;

  if (contentType) {
    data = form.find('[data-override="content"]').val() || ''

    if (contentType === 'multipart/form-data') {
      // We need to add a boundary parameter to the header
      // We assume the first valid-looking boundary line in the body is correct
      // regex is from RFC 2046 appendix A
      var boundaryCharNoSpace = "0-9A-Z'()+_,-./:=?";
      var boundaryChar = boundaryCharNoSpace + ' ';
      var re = new RegExp('^--([' + boundaryChar + ']{0,69}[' + boundaryCharNoSpace + '])[\\s]*?$', 'im');
      var boundary = data.match(re);
      if (boundary !== null) {
        contentType += '; boundary="' + boundary[1] + '"';
      }
      // Fix textarea.value EOL normalisation (multipart/form-data should use CR+NL, not NL)
      data = data.replace(/\n/g, '\r\n');
    }
  } else {
    contentType = form.attr('enctype') || form.attr('encoding')

    if (contentType === 'multipart/form-data') {
      if (!window.FormData) {
        alert('Your browser does not support AJAX multipart form submissions');
        return;
      }

      // Use the FormData API and allow the content type to be set automatically,
      // so it includes the boundary string.
      // See https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects
      contentType = false;
      data = new FormData(form[0]);
    } else {
      contentType = 'application/x-www-form-urlencoded; charset=UTF-8'
      data = form.serialize();
    }
  }


  var ret = $.ajax({
    url: url,
    method: method,
    data: data,
    contentType: contentType,
    processData: false,
    headers: {
      'Accept': 'text/html; q=1.0, */*'
    },
  });

  ret.always(function(data, textStatus, jqXHR) {
    if (textStatus != 'success') {
      jqXHR = data;
    }

    var responseContentType = jqXHR.getResponseHeader("content-type") || "";

    /*
    if (responseContentType.toLowerCase().indexOf('text/html') === 0) {
      replaceDocument(jqXHR.responseText);

      try {
        // Modify the location and scroll to top, as if after page load.
        history.replaceState({}, '', url);
        scroll(0, 0);
      } catch (err) {
        // History API not supported, so redirect.
        window.location = window.location.pathname;
      }
    } else {
      // Not HTML content. We can't open this directly, so redirect.
      window.location = window.location.pathname;
    }
    */
    window.location = window.location.pathname;
  });

  return ret;
}


function captureSubmittingElement(e) {
  var target = e.target;
  var form = this;

  form.clk = target;
}


$.fn.ajaxForm = function() {
  var options = {}

  return this
    .unbind('submit.form-plugin  click.form-plugin')
    .bind('submit.form-plugin', options, doAjaxSubmit)
    .bind('click.form-plugin', options, captureSubmittingElement);
};

///////////
function change_id_to_name(){
  $('#post-object-form  select').each(function(){

    select=$(this);
    var field_name = $(select).attr('name');
    if (field_name == "") {
      return true;
    }

    $('td.' + field_name).each(function(){
      var cell = $(this);
      var field_id = $(this).html();
      if (field_id == "") {
        return true;
      }
      var option = 'option[value=' + field_id + ']';
      var text = $(select).find(option).html();
      cell.html(text);
    });
  });
};


function change_code_to_label(){

  $('#post-object-form  .form-group').each(function(){
     var form_group = $(this);
     field_label = $(form_group).find('label').html().trim();
     var field_name = form_group.find('input').attr('name');

     if (field_name == null){
        field_name = form_group.find('select').attr('name');
     }

      $('th.' + field_name).each(function(){
        $(this).html(field_label);
      });
  });
};


function updateForm(url){
    $.ajax({
      url: url + '?format=table',
      type: 'GET',
      error: function(xhr, status, error) {
        alert(xhr.responseText);
      },
      success : function(data){
        let parser = new DOMParser();
        const doc = parser.parseFromString(data, 'text/html');
        var updateForm = doc.getElementById('put-object-form');
        $("#update_modal_body").append(updateForm);
        $('form').ajaxForm();
      }
    });

}


$(document).ready(function() {
  $('form').ajaxForm();
  change_id_to_name();
  change_code_to_label();

  $('.btn-delete').click(function(){
    var action = $(this).attr('action');
    var form = $('#deleteModal').find('form');
    form.attr('action', action);

    delete_msg = '';
    $(this).parent().parent().find("td").each(function(i, td){
      if (i==0 ){ return null;}
      delete_msg += '<b>' + td.className + '</b> : ' + td.getInnerHTML() + '<br>';
    });
    $("#delete_msg").html(delete_msg);
  });

  $('.btn-update').click(function(){
    var url = $(this).attr('action');
    updateForm(url);
  });

});


  </script>
{% endblock %}