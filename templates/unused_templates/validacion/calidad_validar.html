{% extends "base.html" %}
{% load bootstrap4 %}

{% block content %}

<style type="text/css">
    .popup-overlay {
        visibility:hidden;
        position:fixed;
        background-size:100% 100%;
        height: 100%;
        width: 100% ;
        left: 0;
        top: 0;
        z-index: 1;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
    }

    .popup-content {
        position:relative;
        margin:0 auto;
        visibility:hidden;
        height:20%;
        width:40%;
        vertical-align: middle;
    }
    .mensaje{
        vertical-align: middle;
        text-align: center;
    }
    .popup-overlay.active{visibility:visible;}
    .popup-content.active{visibility:visible;}

    .filtro{
    background: rgba(255,255,255,0.6);
    }

    .titulo{
    background: rgba(200,120,255,0.6);
    }
</style>

<script>


var error_validacion = false;

function activar_espera(){
    $("#div_loading").show();
    $("#div_informacion").hide();
}


function desactivar_espera(){
    $("#div_loading").hide();
    $("#div_informacion").show();
}


function periodos_validacion(){
    $.ajax({
        url: "{% url 'validacion:calidad_periodos_validacion' %}",
        data: $("#form_validacion").serialize(),
        type:'POST',
        beforeSend: function () {
            activar_espera();
            $("#div_error").hide();
        },
        success: function (data) {
            $("#btn_periodos_validacion").attr("disabled", false);
            $("#div_informacion").html(data);
            desactivar_espera();
            $("#div_error").hide();
        },
        error: function () {
            $("#div_informacion").hide();
            $("#div_loading").hide();
            $("#div_error").show();
        }
    });
}


function consultar_profundidades(){
    $("#id_profundidad").prop( "disabled", true );
    $("#id_profundidad").find('option').remove().end()
    $("#id_profundidad").append('<option value selected>---------</option>');
    $("select").addClass("use-placeholder");
    window.mostrar_label_dentro_de_select();

    $.ajax({

        /////////////////////////
        // // Este metodo utiliza GET: No requiere serializar el token.
        // //                          Para usar el POST usar lo de abajo y comentar dataType json
        //data: $("#form_validacion").serialize(),
        //type:'POST',
        //
        //
        // Ejemplos de POST y GET:
        //                          medicion/views.py: variables() y validacion_enviar()
        //                          medicion_filter.html
        //
        /////////////////////////

        url: '{% url "validacion:profundidades" %}',
        data: {
            'estacion_id': $("#id_estacion").val(),
            'variable_id': $("#id_variable").val()
        },
        dataType: 'json',
        beforeSend: function () {
            activar_espera();
            $("#div_error").hide();
        },
        success: function (data) {
            $.each(data, function(index, value) {
                $("#id_profundidad").append('<option value="' + index + '">' + value + '</option>');
            });
            $("#id_profundidad").prop( "disabled", false );
            desactivar_espera();
            $("#div_error").hide();
        },
        error: function () {
            $("#div_informacion").hide();
            $("#div_loading").hide();
            $("#div_error").show();
        }
    });

}




function tabla_validacion(){
    $.ajax({
        url: "{% url 'validacion:calidad_validar' %}",
        data: $("#form_validacion").serialize(),
        type:'POST',
        beforeSend: function () {
            activar_espera();
            $("#div_error").hide();
        },
        success: function (data) {
            $("#btn_validacion_enviar").attr("disabled", false);
            $("#div_informacion").html(data);
            window.gid = $('.plotly-graph-div,.js-plotly-plot').attr('id');
            window.plot_orig_width = $("#" + window.gid).width();
            desactivar_espera();
            $("#div_error").hide();
            plot_adjust();
        },
        error: function () {
            $("#div_informacion").hide();
            $("#div_loading").hide();
            $("#div_error").show();
        }
    });

}





$(document).ready(function() {

    $("#btn_validacion_enviar").attr("disabled", true);
    $("select").addClass("use-placeholder");
    window.mostrar_label_dentro_de_select();

    $(".close").on("click", function(){
        $("#mensaje_overlay, #mensaje_content").removeClass("active");
        if (!error_validacion){
            $('#id_limpiar span').click();
        }
    });

    $("#id_variable").change(function () {
        consultar_profundidades();
    });


    $("#id_estacion").change(function () {
        var estacion = $(this).val();
        cargar_variables(estacion);
    });

    $( "#id_inicio" ).datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat:"yy-mm-dd",
        yearRange: '2018:'+(new Date).getFullYear()
    });

    $( "#id_fin" ).datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat:"yy-mm-dd",
        yearRange: '2018:'+(new Date).getFullYear()
    });

    $( "#div_edit" ).dialog({
        autoOpen: false,
        width:400,
        height:350
    });

    $( "#div_delete" ).dialog({
        autoOpen: false,
        width:400,
        height:350
    });

    $("#btn_periodos_validacion").on('click', function(event){
        var valido_est = $("#id_estacion")[0].checkValidity();
        var valido_var = $("#id_variable")[0].checkValidity();
        var valido_pro = $("#id_profundidad")[0].checkValidity();
        if (valido_est && valido_var && valido_pro) {
            event.preventDefault();
            periodos_validacion();
        }
    });

    $("#btn_validar").on('click', function(event){
        var valido = $("#form_validacion")[0].checkValidity();
        if (valido) {
            event.preventDefault();
            tabla_validacion();
        }
    });

});

</script>

<div class="row titulo p-2">
    <div class="col">
        <h4>Validaci贸n</h4>
    </div>
    <div class="col">
        <a id="id_limpiar" class="btn btn-light" href="{% url 'validacion:calidad_validar' %}"><span>Limpiar</span></a>
    </div>
</div>

<div class="filtro mt-1">
    <form id="form_validacion" class="form" method="post" autocomplete="off">
        {% csrf_token %}

        <div class="row"><div class="col">
            <div style="width:16em;display:inline-block;">
                {% bootstrap_field form.estacion show_label=False %}
            </div>
            <div style="width:16em;display:inline-block;">
                {% bootstrap_field form.variable show_label=False %}
            </div>
            <div style="width:8em;display:inline-block;">
                {% bootstrap_field form.profundidad show_label=False %}
            </div>
            <div style="width:10em;display:inline-block;">
                {% bootstrap_field form.inicio show_label=False %}
            </div>
            <div style="width:10em;display:inline-block;">
                {% bootstrap_field form.fin show_label=False %}
            </div>
            <div style="max-width:16em;display:inline-block;">
                <button id="btn_periodos_validacion" type="submit" class="btn btn-info">Consultar</button>
                <button id="btn_validar" type="submit" class="btn btn-primary">Validar</button>
            </div>
        </div></div>
    </form>
</div>


<div id="mensaje_overlay" class="popup-overlay"  >
    <br><br><br>
    <center><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></center>
    <div id="mensaje_content" class="popup-content">
        <a id="clover" class="close" href="#/">Cerrar</a>
        <h2><div id="mensaje_texto"></div></h2>
     </div>
</div>


<br>
<div id="div_informacion" >
</div>

<div id="div_edit" title="Modificar Informaci贸n">
</div>

<div id="div_delete" title="Eliminar Informaci贸n">
</div>

<div id="div_loading" class="row" style="display:none;">
    <div class="col mt-5 mb-5 d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
    </div>
</div>


<div id="div_error" class="row" style="display:none;">
    <div class="col d-flex justify-content-center">
        <div class="alert alert-danger alert-dismissible" role="alert">
        Ocurrio un problema con el procesamiento de la informaci贸n, por favor intentelo nuevamente
        </div>
    </div>
</div>
{% endblock %}