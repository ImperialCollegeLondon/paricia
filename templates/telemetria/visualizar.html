{% extends "base.html" %}
{% load static %}
{% load bootstrap4 %}

{% block javascript %}
{{ super }}

<script src="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css" rel="stylesheet" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>

var table;
var map;
var refrescar;
var puntos = [];
var graf_width;
var graf_height;
var graf_margin_right = 5;
var graf_margin_top = 40;
var graf_margin_bottom = 45;
var graf_margin_left = 35;
var legends = {};
var _punto = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": []
                },
                "properties": {
                    "tipo": "",
                    "description": "",
                    "estacion_id": "",
                },
            };

var tipos = {
            "Climatológica": {"color": "#007c00",},
            "Hidrométrica": {"color": "#7c007c",},
            "Pluviométrica": {"color": "#ffff00",},
            };

var modebar = {
            "displaylogo": false,
            "modeBarButtonsToRemove": ['showSendToCloud', 'editInChartStudio', 'zoom2d', 'pan2d', 'select2d', 'lasso2d',
                'drawclosepath', 'drawopenpath', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'hoverClosestCartesian',
                'hoverCompareCartesian', 'toggleSpikelines',
            ]
        };


function iniciar_mapa(){
    mapboxgl.accessToken = 'pk.eyJ1IjoicGFibG8tdWlvMjAyMCIsImEiOiJjazU5cG1ncDIwcnd4M2xvMXNkaHlhNDEyIn0.hNSx3eMIBzAVuoftwdvQPg';
    map = new mapboxgl.Map({
        container: 'map',
        zoom: 4,
        center: [-74, -10],
        style: 'mapbox://styles/mapbox/outdoors-v11'
        //style: 'mapbox://styles/mapbox/satellite-v9'
    });
}

function dibujar_estacion(){

    table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
        var data = this.data();
        var punto = JSON.parse(JSON.stringify(_punto));
        punto.geometry.coordinates = [data[4], data[5]];
        punto.properties.description = data[1] + '<br>' + data[2];
        punto.properties.tipo = data[3];
        punto.properties.estacion_id = data[0];
        puntos.push(punto);
    });



    map.on('style.load', function (e) {
        map.addSource('markers', {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": puntos
            }
        });


        var maplayer = {
            "id": "estaciones",
            "source": "markers",
            "type": "circle",
            "paint": {
                "circle-radius": 12,
                "circle-color": ["case",
                                      ["==", ["get", "tipo"], "Hidrométrica"], tipos["Hidrométrica"].color,
                                      ["==", ["get", "tipo"], "Climatológica"], tipos["Climatológica"].color,
                                      ["==", ["get", "tipo"], "Pluviométrica"], tipos["Pluviométrica"].color,
                                      "#ffffff"
                                        ],
                "circle-opacity": 0.6,
                "circle-stroke-width": 1,
            },
        };

        map.addLayer(maplayer);
        
        map.on('mousemove', "estaciones", (e) => {
            map.getCanvas().style.cursor = 'pointer';
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) { coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;}
            $(".mapboxgl-popup").remove();
            new mapboxgl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
        });

        map.on('mouseleave', "estaciones",  function() {
            $(".mapboxgl-popup").remove();
            map.getCanvas().style.cursor = '';
        });

        map.on('click', 'estaciones', function(e) {
            var estacion_id = e.features[0].properties.estacion_id;
            $("input[name='estacion']").val(estacion_id);
            mostrar_graficas();
        });

    });

}




function suma(datos, decimales){
    var res = 0;
    var tmp;
    for ( const i in datos){
        tmp = parseFloat(datos[i]);
        if (! isNaN(tmp)){
            res = res + tmp;
         }
    }
    res = res.toFixed(decimales);
    return res;
}

function maximo(datos){
    var res = -Infinity;
    var tmp;
    for (const i in datos){
        tmp = parseFloat(datos[i]);
        if (! isNaN(tmp)){
            if (tmp > res){
                res = tmp;
            }
        }
    }
    return res;
}


function minimo(datos){
    var res = Infinity;
    var tmp;
    for (const i in datos){
        tmp = parseFloat(datos[i]);
        if (! isNaN(tmp)){
            if (tmp < res){
                res = tmp;
            }
        }
    };
    return res;
}

function renombrar_legends(graf){
    var trace_index = 0;
    $("#graf" + graf).find("g .traces").each(function(){
        trace_index++;
        var legend_text = legends[graf][trace_index];
        if (legend_text){
            $(this).find(".pointtext text").html(legend_text);
         }
    });
}



function mostrar_graficas(){
    enviar_consulta();
    refrescar = setInterval(enviar_consulta, 150000);
}


function limpiar_graficos(){
    $("#rowgraf").html("");
    clearInterval(refrescar);
}

function enviar_consulta(){
    var inicio = $('#id_inicio').val() ;
    $("input[name='inicio']").val(inicio);
    $.ajax({
        url: "{% url 'telemetria:consulta' %}",
        data: $("#form_telemetria").serialize(),
        type:'POST',
        beforeSend: function () {
            $(".modal").modal();
        },
        success: function (result) {
            cargar_datos(result);
        },
        error: function () {
        }
    });
};


function cargar_datos(data){
    calcular_tamaño();
    $('#rowgraf').html("");
    var graf = 0;
    for (const var_id in data){
        graf = graf + 1;
        $('#rowgraf').append("<div id='graf"+ graf+ "' class='grafico col' ></div>");
        if (var_id == 1){
            grafico_serie_barras(data[var_id], graf);
        }
        else if (var_id == 405){
            grafico_viento(data[var_id], graf);
        }else{
            grafico_serie_lineas(data[var_id], graf);
        }
        $("#graf"+ graf).show();
    }

}

function calcular_tamaño(){
    if ( $(window).width() < 600 ){
        graf_width = Math.floor( $(window).width() ) - 20;
    }else if ( $(window).width() < 1000 ){
        graf_width = Math.floor( $(window).width() /2) - 20;
    }else{
        graf_width = Math.floor( $(window).width() /3) - 10;
    }

    if ( $(window).height() < 500 ){
        graf_height = Math.floor( $(window).height()) - 20;
    }else{
        graf_height = Math.floor( $(window).height() / 2) - 10;
    }
};

function reestablecer_tamaño(){
    $( ".grafico" ).each( function () {
        var gid = $(this).attr('id');
        Plotly.relayout(gid, {width:graf_width , height:graf_height});
    });

}

function grafico_serie_barras(data, graf){
    var fecha_ini = data.datos.fecha[0];
    var fecha_fin = data.datos.fecha[data.datos.fecha.length-1];
    var valor_fin = parseFloat(data.datos.valor[data.datos.fecha.length-1]);
    var valor_max = maximo(data.datos.valor);
    var valor_min = minimo(data.datos.valor);
    var umbral_superior = data.umbral_superior;
    var valor_acumulado = suma(data.datos.valor, 2);
    var gdata = [];
    var idx = 0;

    legends[graf] = {};

    var trace = {
        name: 'Datos',
        x: data.datos.fecha,
        y: data.datos.valor,
        type: 'bar',
        marker: {color: 'rgb(0, 90, 0)',
                line: {width:0.3, color:'rgb(0,0,0)'},
                }
    };
    gdata.push(trace);
    idx = idx + 1;


    if (umbral_superior){
        gdata.push({
            name: umbral_superior ,
            x: [fecha_ini, fecha_fin],
            y: [umbral_superior, umbral_superior],
            type: 'scatter',
            mode: 'lines+text',
            line: {
                color: 'rgb(255, 127, 0)',
                width: 1
            },
            connectgaps: true
        });

        idx = idx + 1;
        legends[graf][idx] = 'U S';
     }


    if (!isNaN(valor_acumulado) ){
        gdata.push({
            name: valor_acumulado,
            x: [fecha_ini],
            y: [null],
            type: 'scatter',
            mode: 'text',
        });
        idx = idx + 1;
        legends[graf][idx] = 'ACU';
     };


    if (isFinite(valor_max) ){
        gdata.push({
            name: valor_max,
            x: [fecha_ini],
            y: [null],
            type: 'scatter',
            mode: 'text',
        });
        idx = idx + 1;
        legends[graf][idx] = 'Máx';
     };


    if (isFinite(valor_min) ){
        gdata.push({
            name: valor_min,
            x: [fecha_ini],
            y: [null],
            type: 'scatter',
            mode: 'text',
        });
        idx = idx + 1;
        legends[graf][idx] = 'mín';
     };


    var layout = {
        title: data.estacion + ': ' + data.var_nombre + ' (' + data.var_unidad + ')',
        width: graf_width,
        height: graf_height,
        margin: {
            r: graf_margin_right,
            t: graf_margin_top,
            b: graf_margin_bottom,
            l: graf_margin_left,
            pad: 0
        },
        yaxis: {
            rangemode: 'nonnegative',
            autorange: true
        },
        bargap :0,
    };

    if (!isNaN(valor_fin) ){
        var texto_ultimo = '<br><br>Último:<br><b>' + valor_fin +'</b><br>';
        texto_ultimo = texto_ultimo +  fecha_fin.slice(0,10) + '<br>' + fecha_fin.slice(11,19);
        layout.annotations = [
            {
                align: 'left',
                text: texto_ultimo,
                xref: 'paper',
                x: 1.05,
                xanchor: 'left',
                yref: 'paper',
                y: 0.35,
                yanchor: 'top',
                showarrow: false,
            }
        ];
     };


    var graf_class = 'graf'+graf;
    Plotly.newPlot(graf_class, gdata, layout, modebar);

    renombrar_legends(graf);
    $('#' + graf_class).on('plotly_restyle', function(clickData){
        renombrar_legends(graf);
    });

}

function grafico_serie_lineas(data, graf){
    var fecha_ini = data.datos.fecha[0];
    var fecha_fin = data.datos.fecha[data.datos.fecha.length-1];
    var valor_fin = parseFloat(data.datos.valor[data.datos.fecha.length-1]);
    var valor_max = maximo(data.datos.valor);
    var valor_min = minimo(data.datos.valor);
    var umbral_superior = data.umbral_superior;
    var umbral_inferior = data.umbral_inferior;
    var gdata = [];
    var idx = 0;

    legends[graf] = {};

    var trace = {
        name: 'Datos',
        x: data.datos.fecha,
        y: data.datos.valor,
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: 'rgb(0, 90, 0)',
            width: 1
        },
        marker: {size: 1, color: 'rgb(0, 90, 0)',},
        connectgaps: false
    };
    gdata.push(trace);
    idx = idx + 1;


    if (umbral_superior){
        gdata.push({
            name: umbral_superior ,
            x: [fecha_ini, fecha_fin],
            y: [umbral_superior, umbral_superior],
            type: 'scatter',
            mode: 'lines+text',
            line: {
                color: 'rgb(255, 127, 0)',
                width: 1
            },
            connectgaps: true
        });

        idx = idx + 1;
        legends[graf][idx] = 'U S';
     }


    if (umbral_inferior){
        gdata.push({
            name: umbral_inferior ,
            x: [fecha_ini, fecha_fin],
            y: [umbral_inferior, umbral_inferior],
            type: 'scatter',
            mode: 'lines+text',
            line: {
                color: 'rgb(0, 127, 255)',
                width: 1
            },
            connectgaps: true
        });

        idx = idx + 1;
        legends[graf][idx] = 'U i';
     }


    if (isFinite(valor_max) ){
        gdata.push({
            name: valor_max,
            x: [fecha_ini],
            y: [null],
            type: 'scatter',
            mode: 'text',
        });
        idx = idx + 1;
        legends[graf][idx] = 'Máx';
     };


    if (isFinite(valor_min) ){
        gdata.push({
            name: valor_min,
            x: [fecha_ini],
            y: [null],
            type: 'scatter',
            mode: 'text',
        });
        idx = idx + 1;
        legends[graf][idx] = 'mín';
     };



    var layout = {
        title: data.estacion + ': ' + data.var_nombre + ' (' + data.var_unidad + ')',
        width: graf_width,
        height: graf_height,
        margin: {
            r: graf_margin_right,
            t: graf_margin_top,
            b: graf_margin_bottom,
            l: graf_margin_left,
            pad: 0
        },
    };


    if (!isNaN(valor_fin) ){
        var texto_ultimo = '<br><br>Último:<br><b>' + valor_fin +'</b><br>';
        texto_ultimo = texto_ultimo +  fecha_fin.slice(0,10) + '<br>' + fecha_fin.slice(11,19);
        layout.annotations = [
            {
                align: 'left',
                text: texto_ultimo,
                xref: 'paper',
                x: 1.05,
                xanchor: 'left',
                yref: 'paper',
                y: 0.35,
                yanchor: 'top',
                showarrow: false,
            }
        ];

     };



    var graf_class = 'graf'+graf;
    Plotly.newPlot(graf_class, gdata, layout, modebar);

    renombrar_legends(graf);
    $('#' + graf_class).on('plotly_restyle', function(clickData){
        renombrar_legends(graf);
    });


}


function grafico_viento(data, graf){
    var n = data.datos.velocidad.length;
    var velocidad_fin = parseFloat(data.datos.velocidad[n-1]);
    var direccion_fin = data.datos.direccion[n-1];
    var valor_max = maximo(data.datos.velocidad);
    var datav = [];

    var idx = 0;
    legends[graf] = {};


    var datos = {
        name: "<br>Último:<br><b>" + velocidad_fin + "</b><br>",
        type: "barpolar",
        r: [velocidad_fin,],
        theta: [direccion_fin,],
        thetaunit: 'degrees',
        marker: {color: "rgb(64, 64, 255)"},
    };
    if (n > 0 ){
        datav.push(datos);
        idx++;
    };


    var anteriores =  {
          name: "anteriores",
          type: "scatterpolargl",
          r: data.datos.velocidad,
          theta: data.datos.direccion,
          thetaunit: 'degrees',
          mode: "markers",
          marker: {
            color: "rgb(27,158,119)",
            size: 10,
            line: {
              color: "white"
            },
            opacity: 0.10
          },
          cliponaxis: false
        };
    datav.push(anteriores);
    idx++;


    if ( isFinite(valor_max) ){
        datav.push(
            {
                  type: "scatterpolargl",
                  r: [null],
                  theta: [0],
                  thetaunit: 'degrees',
                  mode: "text",
                  name: valor_max,
                  cliponaxis: false,
                  showlegend: true
            },
        );
        idx++;
        legends[graf][idx] = 'Máx';
     }


    var layout = {
        title: data.estacion + ': '+ data.var_nombre + ' (' + data.var_unidad + ')',
        showlegend: true,
        polar: {
          bgcolor: "rgb(233, 233, 233)",
          angularaxis: {
            tickwidth: 2,
            linewidth: 3,
            direction: 'clockwise',
          },
          radialaxis: {
            side: "counterclockwise",
            showline: true,
            linewidth: 2,
            tickwidth: 2,
            gridcolor: "#FFF",
            gridwidth: 2
          },
        },
        paper_bgcolor: "rgb(255, 255, 255)",
        width: graf_width,
        height: graf_height,
        margin: {
            r: graf_margin_right,
            t: graf_margin_top,
            b: graf_margin_bottom,
            l: graf_margin_left,
            pad: 0
        },
      }

    var graf_class = 'graf'+graf;
    Plotly.newPlot(graf_class, datav, layout, modebar);
    renombrar_legends(graf);
    $('#' + graf_class).on('plotly_restyle', function(clickData){
        renombrar_legends(graf);
    });


    // renombrar angular axis
    var angulo_index = 0;
    var angulo_dict = {1:'N', 2:'NE', 3:'E', 4:'SE', 5:'S', 6:'SO', 7:'O', 8:'NO'};
    $("g.polarsublayer").find("g.angularaxistick").each(function(){
        angulo_index++;
        $(this).find("text").html(angulo_dict[angulo_index]);
    });

}



$(document).ready(function() {

    $("select").addClass("use-placeholder");
    window.mostrar_label_dentro_de_select();

    iniciar_datepicker_generic("#id_inicio");
    $("#id_inicio").datepicker().datepicker("setDate", new Date());

    table = $('#table_estacion').DataTable({
        language: window.DATATABLES_LANGUAGE,
        "scrollY":        "440px",
        "scrollCollapse": true,
        "paging":         false,
        "dom": 'rt',
        columnDefs: [
            { "targets": 0, "visible" : false, "searchable": false },
            { "targets": 1, "defaultOrder": true, "searchable": true },
            { "targets": 2, "visible" : false, "searchable": true },
            { "targets": 3, "visible" : false, "searchable": false },
            { "targets": 4, "visible" : false, "searchable": false },
        ],
    });

    // Asociar búsqueda con caja de selección
    table.columns(2).every( function(){
        var column = this;
        var select = $('#filtro_tipo').on( 'change', function () {
            var val = $.fn.dataTable.util.escapeRegex(
                $(this).val()
            );

            column
                .search( val ? '^'+val+'$' : '', true, false )
                .draw();
        } );
        column.data().unique().sort().each( function ( d, j ) {
            select.append( '<option value="'+d+'">'+d+'</option>' )
        } );
    } );

    iniciar_mapa();
    $("#table_estacion").show();
    dibujar_estacion();

    $( "#filtro_tipo" ).on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        if (valueSelected == ""){
            map.setFilter('estaciones', null);
        }else{
            map.setFilter('estaciones', ['==', 'tipo', valueSelected]);
        };
    });


    $("#table_estacion").on('click', 'tr', function (e) {
        var data = table.row( this ).data();
        var estacion_id = data[0];
        $("input[name='estacion']").val(estacion_id);
        mostrar_graficas();
    });

    $("#table_estacion").on('mouseenter', 'tr', function (e) {
        var data = table.row( this ).data();
        var estacion_id = data[0];
        var coordinates = [Number(data[3]), Number(data[4])];
        var description = data[1];
        //while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) { coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;}
        $(".mapboxgl-popup").remove();
        new mapboxgl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
    });

    $("#table_estacion").on('mouseleave', 'tr', function (e) {
        $(".mapboxgl-popup").remove();
    });

    $(".modal-dialog .close").on("click", function(){
        limpiar_graficos();
    });

});


$(document).keyup(function(e) {
    if (e.key === "Escape") {
        limpiar_graficos();
    }
});

$( window ).resize(function() {
    calcular_tamaño();
    reestablecer_tamaño();
});

</script>

<style>
    .panel-menu {max-width: 270px;}
    #map { position: relative; top: 0; bottom: 0; width: 100%; height: 88vh; }
    #table_estacion tbody tr { cursor: pointer; }

    #rowgraf { margin-left: 0px; margin-right: 0px; }
    .grafico.col {margin-top: 5px; padding: 0px; }

    .modal-dialog {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: auto;
        z-index: 200;
        margin: 0px;
    }



</style>
{% endblock %}


{% block content %}


<div class="row transp-blanco">
    <div class="col transp-blanco panel-menu">
        <div class="row"><div class="col"><h5>Telemetría</h5></div></div>

        <form id="form_telemetria" class="form" method="post">
        {% csrf_token %}
            <div class="row"><div class="col fecha">
                <div class="form-group mb-0">
                    <label class="sr-only" for="id_inicio">Fecha de inicio</label>
                    <input type="text" name="inicio" autocomplete="off" class="form-control"
                           placeholder="Fecha de inicio" title="" id="id_inicio">
                </div>
            </div></div>

            <input type="hidden" value="" name="estacion"/>
            <input type="hidden" value="" name="inicio"/>
        </form>

        <div class="row mt-3 mb-1"><div class="col tipo">
            <label class="sr-only" >Filtrar por tipo</label>
                <select id="filtro_tipo" class="form-control use-placeholder" >
                    <option value="">---------</option>
                </select>
        </div></div>

        <div class="row"><div class="col lista">
            <table id="table_estacion" class="table table-hover table-sm overflowtooltip" style="display:none;">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Estación</th>
                    <th>Tipo</th>
                    <th>Latitud</th>
                    <th>Longitud</th>
                </tr>
                </thead>

                <tbody>{{ estacion|safe }}</tbody>
            </table>
        </div></div>

    </div>

    <div class="col panel-mapa">
        <div id="map"></div>

        <div id="div_loading" class="centr-h mt-5" style="display:none;" >
            <div class="spinner-border text-primary" role="status"><span class="sr-only">Cargando...</span></div>
        </div>

        <div id="div_error" class="centr-h mt-5" style="display:none;" >
            <div class="alert alert-danger alert-dismissible" role="alert">
                Ocurrio un problema con el procesamiento de la información, por favor intentelo nuevamente
            </div>
        </div>

    </div>


</div>

<div class="modal fade" tabindex="-1" role="dialog" style="display:none;">

    <div class="modal-dialog" role="document">
        <a class="btn btn-danger btn-xs close" data-dismiss="modal">&times; Cerrar</a>
    </div>

    <div id="rowgraf" class="row">

    </div>
</div>

{% endblock %}
