{% extends "index.html" %}
{% block content %}
{% load bootstrap3 %}
{% load humanize %}
{% load static %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    .container {
        width: 1350px;
    }

</style>
<script>

var graf_width = 950;
var graf_height = 470;
var graf_margin_right = 15;
var graf_margin_top = 55;
var graf_margin_bottom = 120;
var graf_margin_left = 55;
var legends = {};

$.datepicker.regional['es'] = {
    closeText: 'Cerrar',
    prevText: '< Ant',
    nextText: 'Sig >',
    currentText: 'Hoy',
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
    weekHeader: 'Sm',
    dateFormat: 'yy-mm-dd',
    firstDay: 1,
    isRTL: false,
    showMonthAfterYear: false,
    yearSuffix: ''
};

$.datepicker.setDefaults($.datepicker.regional['es']);


function cargar_datos(data){
    $(".bloque-grafico").empty();
    var ngraf = 0;
    grafico_serie_barras(data, ngraf);

}


function grafico_serie_barras(data, ngraf){

    var trace = {
        name: 'Precip.',
        x: data.estacion,
        y: data.valor,
        type: 'bar',
        marker: {color: 'rgb(32, 32, 90)',},
    };


    var layout = {
        title: 'Precipitación acumulada (mm)',
        width: graf_width,
        height: graf_height,
        margin: {
            r: graf_margin_right,
            t: graf_margin_top,
            b: graf_margin_bottom,
            l: graf_margin_left,
            pad: 0
        },
        yaxis: {
            rangemode: 'nonnegative',
            autorange: true
        },
        xaxis: {
            tickangle: -68,
        },
    };

    var graf_id = 'graf' + ngraf;
    $(".bloque-grafico").append("<div id='" + graf_id + "' style='display:inline-block' ></div>");
    Plotly.newPlot(graf_id, [trace], layout, {showSendToCloud: false,});

}



function enviar_consulta(){
    $.ajax({
        url: "{% url 'telemetria:multiestacion_precipitacion' %}",
        data: $("#form_telemetria").serialize(),
        type:'POST',
        beforeSend: function () {
            $("#div_error").hide();
        },
        success: function (data) {
            $("#div_informacion").show();
            $("#div_loading").hide();
            $("#div_error").hide();
            cargar_datos(data);
        },
        error: function () {
            $("#div_informacion").hide();
            $("#div_loading").hide();
            $("#div_error").show();
        }
    });
};


$(document).ready(function() {

    $( ":checkbox" ).prop('checked', true);

    $("#visualizar").click(function(){
        $(".bloque-grafico").empty();
        $("#div_loading").show();
        $("#div_information").show();
        enviar_consulta();
        $("#div_loading").hide();
        setInterval(enviar_consulta, 150000);
    });

    $("#seleccionar_ninguno").click(function(){
        $( ":checkbox" ).prop('checked', false);
    });

    $("#seleccionar_todos").click(function(){
        $( ":checkbox" ).prop('checked', true);
    });

    $("#id_inicio").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        showButtonPanel: true,
        yearRange: '2000:'+(new Date).getFullYear()
    });

    $("#id_inicio").datepicker().focus(function () {
        $("#ui-datepicker-div").position({ my: "center top", at: "center bottom", of: $("#id_inicio")});
    });


    $("#id_fin").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        showButtonPanel: true,
        yearRange: '2000:'+(new Date).getFullYear()
    });

    $("#id_fin").datepicker().focus(function () {
        $("#ui-datepicker-div").position({ my: "center top", at: "center bottom", of: $("#id_fin")});
    });

    //$("#id_fin").datepicker().datepicker("setDate", new Date());

    $( "#id_fin" ).change(function() {
        $(".bloque-grafico").empty();
    });

    $( "#id_inicio" ).change(function() {
        $(".bloque-grafico").empty();
    });

});


</script>


<form id="form_telemetria" class="form" method="post">
    {% csrf_token %}
    <div class="col-md-12">
    <div class="panel panel-default">
    <div class="panel-heading">
        <div class="row">
            <div class="col-lg-3"><h4 style="display: inline;">Telemetría <br>Precipitación Multiestación</h4></div>
            <div class="col-lg-2"><button id='visualizar' type='button' class='btn btn-success' >Visualizar</button></div>
            <div class="col-lg-2">{% bootstrap_field form.inicio  layout='horizontal' %}</div>
            <div class="col-lg-2">{% bootstrap_field form.fin layout='horizontal' %}</div>
        </div>
    </div>
    </div>
    </div>

    <div class="col-lg-1 col-lg-1-5">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="row top7"><div class="col-lg-12">
                    <a id="seleccionar_ninguno" class="btn btn-default btn-xs" >Ningún</a>
                    <a id="seleccionar_todos" class="btn btn-primary btn-xs" >Todos</a>
                </div></div>
                <div class="row top7"><div class="col-lg-12" style="height:430px; overflow-x:hidden ; overflow-y: scroll; padding-bottom:10px;">
                    <div>{% bootstrap_field form.estacion %}</div>
                </div></div>

            </div>
        </div>
    </div>

</form>


<div class="col-lg-10 col-lg-10-5">
    <div class="panel panel-default">
        <div class="panel-body">

            <div id="div_informacion" >

                <div class="row bloque-grafico">

                </div>
            </div>


            <div id="div_loading" class="row" style="display:none;">
                <div class="col-lg-4 col-md-4 col-sm-4">&nbsp;</div>
                <div class="col-lg-4 col-md-4 col-sm-4">
                    <img src="/media/loading6.gif"/>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4">&nbsp;</div>
            </div>

            <div id="div_error" class="row" style="display:none;">
                <div class="alert alert-danger alert-dismissible" role="alert">
                    Ocurrio un problema con el procesamiento de la información, por favor intentelo nuevamente
                </div>
            </div>


        </div>


        </div>
    </div>
</div>












{% endblock %}