{% extends "base.html" %}
{% load static %}
{% load bootstrap4 %}



{% block javascript %}
{{ super }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
var graf_width = 1100;
var graf_height = 515;
var graf_margin_right = 15;
var graf_margin_top = 55;
var graf_margin_bottom = 120;
var graf_margin_left = 55;
var legends = {};


function cargar_datos(data){
    $(".bloque-grafico").empty();
    var ngraf = 0;
    grafico_serie_barras(data, ngraf);

}


function grafico_serie_barras(data, ngraf){

    var trace = {
        name: 'Precip.',
        x: data.estacion,
        y: data.valor,
        type: 'bar',
        marker: {color: 'rgb(32, 32, 90)',},
    };


    var layout = {
        title: 'Precipitación acumulada (mm)',
        width: graf_width,
        height: graf_height,
        margin: {
            r: graf_margin_right,
            t: graf_margin_top,
            b: graf_margin_bottom,
            l: graf_margin_left,
            pad: 0
        },
        yaxis: {
            rangemode: 'nonnegative',
            autorange: true
        },
        xaxis: {
            tickangle: -68,
        },
    };

    var graf_id = 'graf' + ngraf;
    $(".bloque-grafico").append("<div id='" + graf_id + "' style='display:inline-block' ></div>");
    Plotly.newPlot(graf_id, [trace], layout, {showSendToCloud: false,});

}


function enviar_consulta(){
    $(".bloque-grafico").empty();
    $('#div_error').hide();
    $('#div_informacion').hide();
    $('#div_loading').show();
    $.ajax({
        url: "{% url 'telemetria:multiestacion_precipitacion' %}",
        data: $("#form_telemetria").serialize(),
        type:'POST',
        beforeSend: function () {
        },
        success: function (data) {
            cargar_datos(data);
            $("#div_loading").hide();
            $("#div_informacion").show();
        },
        error: function () {
            $("#div_informacion").hide();
            $("#div_loading").hide();
            $("#div_error").show();
        }
    });
};


$(document).ready(function() {

    $( ":checkbox" ).prop('checked', true);

    $("#visualizar").click(function(){
        enviar_consulta();
        setInterval(enviar_consulta, 150000);
    });

    $("#seleccionar_ninguno").click(function(){
        $( ":checkbox" ).prop('checked', false);
    });

    $("#seleccionar_todos").click(function(){
        $( ":checkbox" ).prop('checked', true);
    });

    $("#id_inicio").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        showButtonPanel: true,
        yearRange: '2000:'+(new Date).getFullYear()
    });

    $("#id_inicio").datepicker().focus(function () {
        $("#ui-datepicker-div").position({ my: "center top", at: "center bottom", of: $("#id_inicio")});
    });


    $("#id_fin").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        showButtonPanel: true,
        yearRange: '2000:'+(new Date).getFullYear()
    });

    $("#id_fin").datepicker().focus(function () {
        $("#ui-datepicker-div").position({ my: "center top", at: "center bottom", of: $("#id_fin")});
    });


    $( "#id_fin" ).change(function() {
        $(".bloque-grafico").empty();
    });

    $( "#id_inicio" ).change(function() {
        $(".bloque-grafico").empty();
    });

    $("select").addClass("use-placeholder");
    window.mostrar_label_dentro_de_select();

    $('.form-group').each(function() {
        window.activar_tooltip($(this));
    });

});

</script>
{% endblock %}

{% block content %}
<style>
    .barra-sup .col {padding: 2px;}
    .form-group { margin-bottom: 2px;}

    .barra-sup>:nth-child(1) {min-width:360px;max-width:360px;}
    .barra-sup>:nth-child(2) {min-width:120px;max-width:140px;}
    .barra-sup>:nth-child(3) {min-width:180px;max-width:220px;}
    .barra-sup>:nth-child(4) {min-width:180px;max-width:220px;}

    #div_estaciones {min-width: 120px; max-width: 120px;}
    #est_checkboxes { height:75vh; overflow-x:hidden ; overflow-y: scroll; padding-bottom:10px;}
    #div_body { overflow-x: auto;}

</style>
<form id="form_telemetria" class="form" method="post">
    {% csrf_token %}
    <div class="row transp-blanco barra-sup">
        <div class="col align-self-center"><h5>Telemetría / Precipitación multiestación</h5></div>
        <div class="col"><button id='visualizar' type='button' class='btn btn-primary' >Visualizar</button></div>
        <div class="col">{% bootstrap_field form.inicio show_label='sr-only' %}</div>
        <div class="col">{% bootstrap_field form.fin show_label='sr-only' %}</div>
    </div>

    <div id="div_body" class="row mt-2 flex-nowrap">
        <div id="div_estaciones" class="col transp-blanco">
            <div class="row">
                <div class="col px-1 text-center">
                    <button type="button" id="seleccionar_ninguno" class="btn btn-outline-dark btn-xs" >Ningún</button>
                    <button type="button" id="seleccionar_todos" class="btn btn-primary btn-xs">Todos</button>
                </div>
            </div>
            <div class="row mt-2">
                <div id="est_checkboxes" class="col">
                    {% bootstrap_field form.estacion %}
                </div>
            </div>
        </div>

        <div id="div_resultados" class="col">

            <div id="div_informacion" class="row">
                <div class="col">
                    <div class="bloque-grafico"></div>
                </div>

            </div>

            <div id="div_loading" class="row" style="display:none;" >
                <div class="col text-center">
                    <div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>
                </div>
            </div>

            <div id="div_error" class="row" style="display:none;">
                <div class="col text-center">
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">&times;</button>
                    Ocurrio un problema con el procesamiento de la información, por favor intentelo nuevamente
                    </div>
                </div>
            </div>


        </div>

    </div>

</form>
{% endblock %}

